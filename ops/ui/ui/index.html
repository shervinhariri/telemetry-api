<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NETREEX API Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: '#0B0C10',
                        surface: '#111218',
                        surfaceHover: '#14151B',
                        border: 'rgba(255,255,255,0.05)',
                        borderHover: 'rgba(255,255,255,0.1)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Utility classes to unify primary buttons (Create / Save) */
        .btn-primary-glow{
          @apply inline-flex items-center justify-center rounded-full px-6 py-3 text-sm font-medium
                 text-white bg-blue-600 hover:bg-blue-500 focus:outline-none
                 shadow-[0_0_25px_rgba(37,99,235,0.4)] transition-all duration-200;
        }
        .btn-secondary{
          @apply inline-flex items-center justify-center rounded-full px-6 py-3 text-sm font-medium
                 bg-white/10 hover:bg-white/20 text-white/90 border border-white/20 transition-all duration-200;
        }
        .drawer-surface{
          @apply bg-[#0f1115] border border-white/10 shadow-2xl;
        }
        .drawer-footer{
          @apply sticky bottom-0 bg-[#0f1115] border-t border-white/10;
        }
        
        html { 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale; 
        }
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }
        
        :root{
          --bg:#0b0f17; --panel:#0f1624; --soft:#141c2e; --line:#1c2740;
          --txt:#e6eefc; --muted:#a7b3cc; --hint:#7d8aa6;
          --brand:#6d5efc; --brand-2:#8f83ff; --ok:#2ecc71; --bad:#ff5d5d; --warn:#ffb84d;
          --r:14px; --pad:12px; --gap:10px; --shadow:0 8px 30px rgba(0,0,0,.25);
          --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
          --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        }

        /* Page containers - matching Requests page styling */
        .card{background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.05); border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.25);}
        .card-header{padding:24px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; align-items:center; gap:10px;}
        .card-title{font:600 16px/1 var(--sans); color:var(--txt);}
        .card-body{padding:24px;}

        /* Toolbar */
        .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
        .toolbar .spacer{flex:1}

        /* Buttons - balanced styling with gray for most, color for important */
        .btn{border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:var(--txt); border-radius:12px; padding:8px 16px; font:500 13px/1 var(--sans); cursor:pointer; transition:all 0.2s;}
        .btn:hover{background:rgba(255,255,255,0.1); border-color:rgba(255,255,255,0.2);}
        .btn:focus{outline:2px solid rgba(255,255,255,0.2); outline-offset:2px;}
        .btn[aria-busy="true"]{opacity:.7; pointer-events:none; position:relative;}
        .btn[aria-busy="true"]::after{content:""; position:absolute; right:8px; top:50%; width:14px; height:14px; border-radius:50%; border:2px solid currentColor; border-top-color:transparent; transform:translateY(-50%); animation:spin .7s linear infinite;}
        @keyframes spin{to{transform:translateY(-50%) rotate(360deg)}}

        .btn--primary{background:rgba(16,185,129,0.25); border-color:rgba(16,185,129,0.4); color:rgba(16,185,129,1);}
        .btn--ghost{background:rgba(255,255,255,0.03); border-color:rgba(255,255,255,0.08); color:rgba(255,255,255,0.7);}

        /* Inputs - matching Requests page styling */
        .input,.codearea{width:100%; background:rgba(255,255,255,0.05); color:var(--txt); border:1px solid rgba(255,255,255,0.1); border-radius:6px; padding:10px 12px; font:500 13px/1.4 var(--sans);}
        .input::placeholder{color:var(--hint);}
        .codearea{font-family:var(--mono); resize:vertical; min-height:160px}

        /* Output box */
        .output-bar{display:flex; align-items:center; gap:8px; margin-top:12px; margin-bottom:8px; color:var(--muted); font:600 12px/1 var(--sans);}
        .codebox{background:rgba(0,0,0,0.3); color:#d6e3ff; border:1px solid rgba(255,255,255,0.1); border-radius:6px; padding:12px; white-space:pre-wrap; word-break:break-word; max-height:340px; overflow:auto; font-family:var(--mono);}

        /* Error box */
        .alert{background:#2b1220; border:1px solid #5c2038; color:#ffd6df; border-radius:6px; padding:10px 12px; margin-bottom:10px;}
        .hidden{display:none}

        /* API Key chip - matching Requests page purple styling */
        .chip {
          display:inline-flex; align-items:center; gap:8px;
          padding:4px 12px; border-radius:999px;
          font:600 12px var(--sans); border:1px solid rgba(139,92,246,0.4);
          cursor:pointer; user-select:none;
          background:rgba(139,92,246,0.15); color:rgba(196,181,253,1);
        }
        .chip--dark { background:rgba(139,92,246,0.15); color:rgba(196,181,253,1); border-color:rgba(139,92,246,0.4); }
        .chip-label { color:rgba(196,181,253,0.8); font-weight:600; }

        /* Inline API Key Editing */
        .api-key-mode { display:flex; align-items:center; gap:8px; }
        .api-key-mode.hidden { display:none; }
        
        .chip-input {
          background:transparent; border:none; color:rgba(196,181,253,1);
          font:600 12px var(--sans); outline:none; min-width:120px;
          padding:0; margin:0;
        }
        .chip-input::placeholder { color:rgba(196,181,253,0.5); }
        
        .chip-btn {
          background:transparent; border:none; color:rgba(196,181,253,1);
          font:600 12px var(--sans); cursor:pointer; padding:2px 4px;
          border-radius:4px; transition:all 0.2s;
        }
        .chip-btn:hover { background:rgba(196,181,253,0.2); }
        .chip-btn--save:hover { background:rgba(16,185,129,0.2); color:rgba(16,185,129,1); }
        .chip-btn--cancel:hover { background:rgba(255,255,255,0.2); color:rgba(255,255,255,1); }
        
        /* Toasts */
        #toast-root {
          position: fixed; right: 16px; bottom: 16px; z-index: 9999;
          display: flex; flex-direction: column; gap: 8px;
        }
        .toast {
          min-width: 260px; max-width: 520px;
          padding: .6rem .8rem; border-radius: 10px; box-shadow: 0 10px 18px rgba(0,0,0,.15);
          color: #0b1020; background: #f5f7ff; border: 1px solid #dfe7ff;
          display:flex; gap:.5rem; align-items: flex-start;
        }
        .toast.success { background:#eefbf0; border-color:#bde8c3; color:#0a3d18; }
        .toast.error   { background:#fff1f1; border-color:#ffcece; color:#7a1a1a; }
        .toast.info    { background:#f5f7ff; border-color:#dfe7ff; color:#0b1020; }
        .toast .title { font-weight:700; margin-right:.25rem; }
        .toast .msg { white-space: pre-wrap; word-break: break-word; }
        .toast .close { margin-left:auto; background:transparent; border:0; cursor:pointer; font-size: 18px; line-height: 1; }
        
        /* Edit drawer green focus styles */
        .edit-drawer input:focus, .edit-drawer select:focus, .edit-drawer textarea:focus {
          outline: none;
          box-shadow: 0 0 0 2px rgba(16,185,129,0.6); /* emerald-500/60 - darker */
          border-color: rgba(16,185,129,0.6);
        }
        
        /* Reusable glow buttons (no Tailwind build required) */
        .btn-glow-blue {
          background: rgba(37, 99, 235, 0.15);        /* blue-600 @ ~15% */
          color: rgba(191, 219, 254, 0.95);           /* text-blue-200ish */
          border: 1px solid rgba(59,130,246,0.35);    /* ring-blue-500/35 */
          border-radius: 16px;                        /* rounded-2xl like tabs */
          padding: 8px 16px;                          /* px-4 py-2 like tabs */
          font-size: 14px;                            /* text-sm like tabs */
          box-shadow: 0 0 22px rgba(37,99,235,0.36);
          backdrop-filter: blur(6px);
          transition: box-shadow .2s, background .2s, transform .05s;
        }
        .btn-glow-blue:hover {
          background: rgba(37, 99, 235, 0.22);
          box-shadow: 0 0 28px rgba(37,99,235,0.55);
        }
        .btn-glow-blue:active { transform: translateY(1px); }

        .btn-glow-green {
          background: rgba(16,185,129,0.16);          /* emerald-500 @ ~16% */
          color: rgba(209,250,229,0.95);              /* text-emerald-100ish */
          border: 1px solid rgba(16,185,129,0.40);
          border-radius: 16px;                        /* rounded-2xl like Create Source */
          padding: 8px 16px;                          /* px-4 py-2 like Create Source */
          font-size: 14px;                            /* text-sm like Create Source */
          box-shadow: 0 0 22px rgba(16,185,129,0.38);
          backdrop-filter: blur(6px);
          transition: box-shadow .2s, background .2s, transform .05s;
        }
        
        .btn-glow-red {
          background: rgba(239,68,68,0.16);           /* red-500 @ ~16% */
          color: rgba(254,226,226,0.95);              /* text-red-100ish */
          border: 1px solid rgba(239,68,68,0.40);
          border-radius: 16px;                        /* rounded-2xl like Create Source */
          padding: 8px 16px;                          /* px-4 py-2 like Create Source */
          font-size: 14px;                            /* text-sm like Create Source */
          box-shadow: 0 0 22px rgba(239,68,68,0.38);
          backdrop-filter: blur(6px);
          transition: box-shadow .2s, background .2s, transform .05s;
        }
        .btn-glow-red:hover {
          background: rgba(239,68,68,0.22);
          box-shadow: 0 0 28px rgba(239,68,68,0.55);
        }
        .btn-glow-red:active { transform: translateY(1px); }
        .btn-glow-green:hover {
          background: rgba(16,185,129,0.22);
          box-shadow: 0 0 28px rgba(16,185,129,0.55);
        }
        .btn-glow-green:active { transform: translateY(1px); }

        .btn-ghost-gray {
          background: rgba(255,255,255,0.06);
          color: rgba(255,255,255,0.85);
          border: 1px solid rgba(255,255,255,0.12);
          border-radius: 16px;                        /* rounded-2xl like Create Source */
          padding: 8px 16px;                          /* px-4 py-2 like Create Source */
          font-size: 14px;                            /* text-sm like Create Source */
          transition: background .15s, transform .05s;
          backdrop-filter: blur(4px);
        }
        .btn-ghost-gray:hover { background: rgba(255,255,255,0.12); }
        .btn-ghost-gray:active { transform: translateY(1px); }

        /* Green focus ring ONLY inside Edit drawer */
        .edit-drawer input:focus,
        .edit-drawer select:focus,
        .edit-drawer textarea:focus {
          outline: none !important;
          box-shadow: 0 0 0 2px rgba(16,185,129,0.8) !important; /* darker emerald */
          border-color: rgba(16,185,129,0.6) !important;
        }
        
        /* Force green glow button styling in edit drawer */
        .edit-drawer .btn-glow-green {
          background: rgba(16,185,129,0.16) !important;
          color: rgba(209,250,229,0.95) !important;
          border: 1px solid rgba(16,185,129,0.40) !important;
          border-radius: 16px !important;
          padding: 8px 16px !important;
          font-size: 14px !important;
          box-shadow: 0 0 22px rgba(16,185,129,0.38) !important;
          backdrop-filter: blur(6px) !important;
          transition: box-shadow .2s, background .2s, transform .05s !important;
        }
        .edit-drawer .btn-glow-green:hover {
          background: rgba(16,185,129,0.22) !important;
          box-shadow: 0 0 28px rgba(16,185,129,0.55) !important;
        }
        
        /* Target the source drawer for edit mode */
        #source-drawer .btn-primary-glow {
          background: rgba(16,185,129,0.16) !important;
          color: rgba(209,250,229,0.95) !important;
          border: 1px solid rgba(16,185,129,0.40) !important;
          border-radius: 16px !important;
          padding: 8px 16px !important;
          font-size: 14px !important;
          box-shadow: 0 0 22px rgba(16,185,129,0.38) !important;
          backdrop-filter: blur(6px) !important;
          transition: box-shadow .2s, background .2s, transform .05s !important;
        }
        #source-drawer .btn-primary-glow:hover {
          background: rgba(16,185,129,0.22) !important;
          box-shadow: 0 0 28px rgba(16,185,129,0.55) !important;
        }
        
        #source-drawer .btn-secondary {
          background: rgba(255,255,255,0.06) !important;
          color: rgba(255,255,255,0.85) !important;
          border: 1px solid rgba(255,255,255,0.12) !important;
          border-radius: 16px !important;
          padding: 8px 16px !important;
          font-size: 14px !important;
          transition: background .15s, transform .05s !important;
          backdrop-filter: blur(4px) !important;
        }
        #source-drawer .btn-secondary:hover {
          background: rgba(255,255,255,0.12) !important;
        }
        
        /* Green focus rings for source drawer inputs */
        #source-drawer input:focus,
        #source-drawer select:focus,
        #source-drawer textarea:focus {
          outline: none !important;
          box-shadow: 0 0 0 2px rgba(16,185,129,0.8) !important;
          border-color: rgba(16,185,129,0.6) !important;
        }
        
        /* Logs body container */
        .logs-output, #logs-output, #logs-pre, #logs-content {
          white-space: pre-wrap;
          word-break: break-word;
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
          line-height: 1.25;
          font-size: 13px;
        }
    </style>
</head>
<body class="min-h-screen w-full bg-[#0B0C10] text-zinc-100 antialiased">
    <div class="max-w-7xl mx-auto px-5 pb-24">
        <div class="sticky top-0 z-30 backdrop-blur bg-[#0B0C10]/70">
            <div class="pt-8 pb-6 flex items-center gap-3">
                <button id="logoLink" type="button" title="Hard refresh" class="inline-flex items-center justify-center px-8 py-3 rounded-2xl bg-neutral-800/60 hover:bg-neutral-700/60 text-white ring-2 ring-emerald-500/60 shadow-[0_0_0_2px_rgba(16,185,129,.25)] transition-colors transition-shadow cursor-pointer">
                    <span class="flex items-center font-bold tracking-tight">
                        <span class="text-white text-lg">NETREE</span>
                        <span class="text-emerald-400 text-3xl">X</span>
                    </span>
                </button>
                <div class="ml-auto flex items-center gap-2 text-xs text-zinc-400">
                    <!-- Global API Key Chip (visible on all pages) -->
                    <div id="api-key-container" class="chip chip--dark" style="position:relative;">
                      <div id="api-key-display" class="api-key-mode">
                        <span class="chip-label">API KEY:</span>
                        <span id="api-key-mask">TEST_KEY</span>
                        <svg aria-hidden="true" width="14" height="14" style="margin-left:8px;opacity:.7;cursor:pointer;">
                          <path fill="currentColor" d="M2 10l4 4 8-8-4-4L2 10z"/>
                        </svg>
                      </div>
                      <div id="api-key-edit" class="api-key-mode hidden">
                        <input id="api-key-input" class="chip-input" placeholder="Enter API key" />
                        <button id="api-key-save" class="chip-btn chip-btn--save">✓</button>
                        <button id="api-key-cancel" class="chip-btn chip-btn--cancel">✕</button>
                      </div>
                    </div>
                    <button id="btn-set-key" class="rounded-lg px-2 py-1 ring-1 ring-white/10 hover:ring-indigo-400/40">Set API Key</button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mt-4 flex gap-2 flex-wrap">
                    <button id="tab-dashboard" class="tab-btn px-4 py-2 rounded-2xl text-sm ring-1 bg-[#14151B] ring-indigo-500/40 text-zinc-100">Dashboard</button>
        <button id="tab-sources" class="tab-btn px-4 py-2 rounded-2xl text-sm ring-1 bg-[#0F1116] ring-white/5 text-zinc-400 hover:text-zinc-200">Sources</button>
        <button id="tab-requests" class="tab-btn px-4 py-2 rounded-2xl text-sm ring-1 bg-[#0F1116] ring-white/5 text-zinc-400 hover:text-zinc-200">System</button>
            <button id="tab-toolbox" class="tab-btn px-4 py-2 rounded-2xl text-sm ring-1 bg-[#0F1116] ring-white/5 text-zinc-400 hover:text-zinc-200">Toolbox</button>
        <button id="tab-logs" class="tab-btn px-4 py-2 rounded-2xl text-sm ring-1 bg-[#0F1116] ring-white/5 text-zinc-400 hover:text-zinc-200">Logs</button>
        </div>

            <!-- Panel: Dashboard -->
    <div id="panel-dashboard" class="panel mt-6">
      <div id="warming-up-banner" class="hidden mb-4"></div>
      <div id="dashboard-error" class="hidden text-xs text-red-400"></div>

        <!-- Top metric tiles -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
            <div class="rounded-2xl bg-neutral-800/60 p-5 transition ring-1 ring-transparent hover:ring-emerald-500/40 hover:shadow-[0_0_0_2px_rgba(16,185,129,.25)] flex flex-col items-center justify-center gap-2">
                <div class="flex items-baseline gap-2">
                    <div class="text-2xl font-semibold leading-none" id="queue-lag">0</div>
                    <div class="text-xs text-zinc-500">ms (p50)</div>
                </div>
                <div class="text-xs uppercase tracking-wide text-zinc-400">Queue Lag</div>
            </div>
            <div class="rounded-2xl bg-neutral-800/60 p-5 transition ring-1 ring-transparent hover:ring-emerald-500/40 hover:shadow-[0_0_0_2px_rgba(16,185,129,.25)] flex flex-col items-center justify-center gap-2">
                <div class="flex items-baseline gap-2">
                    <div class="text-2xl font-semibold leading-none" id="avg-risk">0</div>
                    <div class="text-xs text-zinc-500">0–100 scale</div>
                </div>
                <div class="text-xs uppercase tracking-wide text-zinc-400">Average Risk</div>
            </div>
            <div class="rounded-2xl bg-neutral-800/60 p-5 transition ring-1 ring-transparent hover:ring-amber-500/40 hover:shadow-[0_0_0_2px_rgba(245,158,11,.25)] flex flex-col items-center justify-center gap-2">
                <div class="flex items-baseline gap-2">
                    <div class="text-2xl font-semibold leading-none" id="threat-matches">0</div>
                    <div class="text-xs text-zinc-500">last 15m</div>
                </div>
                <div class="text-xs uppercase tracking-wide text-zinc-400">Threat Matches</div>
            </div>
            <div class="rounded-2xl bg-neutral-800/60 p-5 transition ring-1 ring-transparent hover:ring-rose-500/40 hover:shadow-[0_0_0_2px_rgba(244,63,94,.25)] flex flex-col items-center justify-center gap-2">
                <div id="error-ring" class="grid place-items-center"></div>
                <div class="text-xs uppercase tracking-wide text-zinc-400">Error Rate</div>
            </div>
        </div>


        </div>

        

        <!-- Panel: Requests -->
        <div id="panel-requests" class="panel hidden mt-6">
        <!-- Top stats for requests -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
            <div class="rounded-2xl bg-neutral-800/60 p-5 transition ring-1 ring-transparent hover:ring-emerald-500/40 hover:shadow-[0_0_0_2px_rgba(16,185,129,.25)] flex flex-col items-center justify-center gap-2">
                <div id="success-ring" class="grid place-items-center"></div>
                <div class="text-xs uppercase tracking-wide text-zinc-400">Success Rate</div>
            </div>
            <div class="rounded-2xl bg-neutral-800/60 p-5 transition ring-1 ring-transparent hover:ring-emerald-500/40 hover:shadow-[0_0_0_2px_rgba(16,185,129,.25)] flex flex-col items-center justify-center gap-2">
                <div class="text-2xl font-semibold leading-none" id="avg-latency">0ms</div>
                <div class="text-xs uppercase tracking-wide text-zinc-400">Avg Latency</div>
            </div>
            <button onclick="window.open('/docs','_blank')" class="rounded-2xl bg-neutral-800/60 p-5 transition ring-1 ring-transparent hover:ring-emerald-500/40 hover:shadow-[0_0_0_2px_rgba(16,185,129,.25)] focus:outline-none flex flex-col items-center justify-center gap-2">
                <div class="text-2xl font-semibold leading-none" id="version" data-field="version">0.8.9</div>
                <div class="text-xs uppercase tracking-wide text-zinc-400">Version</div>
            </button>
            <div class="rounded-2xl bg-neutral-800/60 p-5 transition ring-1 ring-transparent hover:ring-emerald-500/40 hover:shadow-[0_0_0_2px_rgba(16,185,129,.25)] flex flex-col items-center justify-center gap-2">
                <div class="text-2xl font-semibold leading-none" id="uptime">—</div>
                <div class="text-xs uppercase tracking-wide text-zinc-400">Uptime</div>
            </div>
            <div class="rounded-2xl bg-neutral-800/60 p-5 transition ring-1 ring-transparent hover:ring-emerald-500/40 hover:shadow-[0_0_0_2px_rgba(16,185,129,.25)] flex flex-col items-center justify-center gap-2">
                <div class="grid gap-2">
                    <div class="text-sm text-zinc-400">UDP Head</div>
                    <div class="text-sm font-medium" data-field="udp-head-status">Stopped</div>
                </div>
            </div>
        </div>
        <div class="mt-2 mb-3 flex items-center justify-between">
            <h2 class="text-xl font-semibold text-white">Recent Requests</h2>
            <div class="flex items-center gap-3">
                <button id="refresh-requests" class="btn-glow-green">Refresh</button>
            </div>
        </div>

        <!-- Table -->
        <div class="overflow-hidden rounded-2xl border border-white/5 bg-white/[0.02]">
            <table class="w-full text-left">
                <thead class="text-zinc-400 text-sm border-b border-white/5">
                    <tr>
                        <th class="px-5 py-3">Health</th>
                        <th class="px-5 py-3">Time</th>
                        <th class="px-5 py-3">Endpoint</th>
                        <th class="px-5 py-3">Status</th>
                        <th class="px-5 py-3">Latency</th>
                        <th class="px-5 py-3">Records</th>
                        <th class="px-5 py-3">Client</th>
                    </tr>
                </thead>
                <tbody id="requests-table" class="divide-y divide-white/5">
                    <tr>
                        <td colspan="7" class="px-5 py-6 text-center text-zinc-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        </div>

        <!-- Panel: Logs -->
        <div id="panel-logs" class="panel hidden mt-6 space-y-4">
            <div id="logs-error" class="hidden text-xs text-red-400"></div>
            <div class="flex items-center gap-3">
                <button id="start-logs" class="btn-glow-green">Start Live</button>
                <button id="stop-logs" class="btn-glow-red">Stop Live</button>
                <button id="download-logs" class="btn-ghost-gray">Download</button>
            </div>
            <pre id="logs-content" class="h-80 overflow-auto bg-black/40 rounded-xl p-4 text-xs text-zinc-300" style="white-space: pre-wrap; word-break: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></pre>
        </div>

        <!-- Panel: Sources -->
        <div id="panel-sources" class="panel hidden mt-6 space-y-4">
            <div id="sources-error" class="hidden text-xs text-red-400"></div>
            
            <!-- Filters -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-zinc-400 mb-1">Tenant</label>
                    <select id="sources-tenant-filter" class="w-full rounded-xl bg-[#14151B] px-3 py-2 text-sm text-zinc-200 outline-none ring-1 ring-white/5 focus:ring-indigo-400/40">
                        <option value="">All Tenants</option>
                        <option value="default">default</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-zinc-400 mb-1">Type</label>
                    <select id="sources-type-filter" class="w-full rounded-xl bg-[#14151B] px-3 py-2 text-sm text-zinc-200 outline-none ring-1 ring-white/5 focus:ring-indigo-400/40">
                        <option value="">All Types</option>
                        <option value="udp">UDP</option>
                        <option value="http">API</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-zinc-400 mb-1">Status</label>
                    <select id="sources-status-filter" class="w-full rounded-xl bg-[#14151B] px-3 py-2 text-sm text-zinc-200 outline-none ring-1 ring-white/5 focus:ring-indigo-400/40">
                        <option value="">All Status</option>
                        <option value="healthy">Healthy</option>
                        <option value="degraded">Degraded</option>
                        <option value="stale">Stale</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-zinc-400 mb-1">Page Size</label>
                    <select id="sources-size-filter" class="w-full rounded-xl bg-[#14151B] px-3 py-2 text-sm text-zinc-200 outline-none ring-1 ring-white/5 focus:ring-indigo-400/40">
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>

            <!-- Add Source Button -->
            <div class="flex justify-end">
                <button id="btn-add-source"
                        data-action="add-source"
                        class="btn-glow-blue">
                  Add Source
                </button>
            </div>

            <!-- Sources Table -->
            <div class="bg-[#14151B] rounded-xl border border-white/5 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-[#0F1116] border-b border-white/5">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Source</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Tenant</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Allowed IPs</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">EPS Cap</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">EPS (1m)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Last Seen</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Error %</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sources-table" class="divide-y divide-white/5">
                            <tr>
                                <td colspan="10" class="px-6 py-4 text-center text-zinc-400">Loading sources...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div id="sources-pagination" class="flex items-center justify-between hidden">
                <div class="text-sm text-zinc-400">
                    Showing <span id="sources-range-start">0</span>–<span id="sources-range-end">0</span> of <span id="sources-total">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="sources-prev" class="px-3 py-1 rounded text-sm bg-[#14151B] text-zinc-300 hover:bg-[#0F1116] disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                    <span class="text-sm text-zinc-400">Page <span id="sources-page">1</span></span>
                    <button id="sources-next" class="px-3 py-1 rounded text-sm bg-[#14151B] text-zinc-300 hover:bg-[#0F1116] disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                </div>
            </div>
        </div>



        <!-- PANEL: TOOLBOX -->
        <section id="panel-toolbox" class="hidden px-4 md:px-6 pb-10">
          <div class="space-y-8">

            <!-- 1) API TOOLS -->
            <section id="toolbox-api-tools" class="mt-6">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">API Tools</div>
                  <div class="spacer"></div>
                </div>

                <div class="card-body">
                <div id="api-error" class="alert hidden"></div>

                <div class="toolbar" style="margin-bottom:10px">
                  <button id="btn-system"  class="btn-glow-blue">/v1/system</button>
                  <button id="btn-metrics" class="btn-glow-blue">/v1/metrics</button>
                  <input id="lookup-value" class="input" placeholder="value for /v1/lookup" />
                  <button id="btn-lookup" class="btn-ghost-gray">Lookup</button>
                  <div class="spacer"></div>
                  <button id="btn-sample-flows" class="btn-ghost-gray">Insert sample flows.v1</button>
                  <button id="btn-sample-zeek"  class="btn-ghost-gray">Insert sample zeek.conn</button>
                  <button id="btn-send-ingest"  class="btn-glow-green">Send ingest</button>
                </div>

                <label for="ingest-payload" style="display:block; margin:6px 0 6px; color:var(--muted); font:600 12px var(--sans);">Ingest payload (JSON)</label>
                <textarea id="ingest-payload" class="codearea" spellcheck="false"></textarea>

                <div class="output-bar">
                  <span>Response</span>
                  <div class="spacer"></div>
                  <button id="btn-copy-output"  class="btn-ghost-gray">Copy</button>
                  <button id="btn-clear-output" class="btn-ghost-gray">Clear</button>
                </div>
                <pre id="api-output" class="codebox"></pre>
                </div>
              </div>
            </section>

            <!-- 2) ENRICHMENT -->
            <section id="toolbox-enrichment">
              <!-- GeoIP card -->
              <div id="card-geoip"
                   class="rounded-2xl ring-1 ring-indigo-500/40 bg-[#14151B] shadow-xl p-4 md:p-6">
                <div class="text-base font-semibold mb-3">GeoIP (MaxMind)</div>
                <label class="flex items-center gap-2 text-sm mb-3">
                  <input type="checkbox" id="geoip-enabled"> Enabled
                </label>

                <div class="mb-3">
                  <input id="geoip-path"
                         class="w-full bg-transparent border border-zinc-700/60 rounded-xl px-3 py-2 text-sm"
                         placeholder="/data/enrichment/&lt;blob&gt;_GeoLite2-City.mmdb">
                </div>

                <div class="flex flex-wrap items-center gap-2 mb-3">
                  <button id="geoip-upload" class="btn">Upload .mmdb</button>
                  <input id="geoip-file" type="file" accept=".mmdb" class="hidden">
                  <button id="geoip-save" class="btn">Save</button>
                  <input id="geoip-test-ip" class="input px-3 py-2 text-sm rounded-xl border border-zinc-700/60 bg-transparent"
                         placeholder="1.1.1.1">
                  <button id="geoip-test" class="btn">Test</button>
                </div>

                <div id="geoip-status" class="muted text-xs hidden"></div>
              </div>
            </section>

          </div>
        </section>
    </div>

    <!-- Slide over for details -->
    <div id="slide-over-backdrop" class="fixed inset-0 bg-black/40 opacity-0 pointer-events-none transition"></div>
    <div id="slide-over" class="fixed inset-y-0 right-0 w-full max-w-md bg-[#111218] border-l border-white/10 translate-x-full transition">
        <div id="slide-over-content" class="p-6 text-sm text-zinc-200"></div>
    </div>

    <!-- Toasts -->
    <div id="toast-root" aria-live="polite" aria-atomic="true"></div>

    <!-- Set API Key Modal -->
    <div id="key-modal" class="fixed inset-0 z-50 hidden">
      <div id="key-modal-backdrop" class="absolute inset-0 bg-black/50"></div>
      <div class="relative mx-auto my-20 max-w-md rounded-2xl bg-[#111218] border border-white/10 p-5 text-sm text-zinc-200">
        <div class="mb-3 flex items-center justify-between">
          <div class="font-semibold">Set API Key</div>
          <button id="key-modal-close" class="btn btn--ghost">✕</button>
        </div>
        <label class="block text-xs text-zinc-400 mb-1">API Key</label>
        <input id="key-modal-input" type="password" class="input" placeholder="Paste your API key" />
        <div id="key-modal-status" class="mt-2 text-xs text-zinc-400"></div>
        <div class="mt-4 flex items-center gap-2 justify-end">
                  <button id="key-modal-test" class="btn">Test</button>
        <button id="key-modal-save" class="btn btn--primary">Save</button>
        <button id="key-modal-cancel" class="btn btn--ghost">Cancel</button>
    </div>
</div>

    <!-- Source Details Modal -->
<div id="source-modal" class="fixed inset-0 z-50 hidden">
    <div id="source-modal-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="bg-[#0f1115]/95 backdrop-blur rounded-xl border border-white/10 w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl edit-drawer" style="width: 540px; max-width: 90vw;">
            <div class="flex items-center justify-between px-6 py-5 border-b border-white/10">
                <h2 class="text-lg font-semibold">Source Details</h2>
                <button id="source-modal-close" class="text-white/60 hover:text-white">✕</button>
            </div>
            
            <div class="p-6 space-y-4">
                <!-- Basic Info -->
                <div>
                    <h4 class="text-sm font-medium text-zinc-400 mb-3">Basic Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-1">Source ID
                              <span class="ml-1 text-xs text-zinc-500" title="Stable identifier for this data source. UDP collectors must set this value in the collector (SOURCE_ID) and it will be sent as X-Source-Id. HTTP senders may pass X-Source-Id or one will be auto-generated per API key.">ⓘ</span>
                            </label>
                            <input id="source-id" type="text" class="input" readonly />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-1">Display Name</label>
                            <input id="source-display-name" type="text" class="input" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-1">Type</label>
                            <div id="source-type-badge"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-1">Origin</label>
                            <div id="source-origin-badge"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-1">Tenant</label>
                            <input id="source-tenant" type="text" class="input" readonly />
                        </div>
                    </div>
                </div>

                <!-- Access & Limits -->
                <div>
                    <h4 class="text-sm font-medium text-zinc-400 mb-3">Access & Limits</h4>
                    <div class="space-y-4">
                        <!-- Status Toggle -->
                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-1">Status</label>
                            <select id="source-status" class="input">
                                <option value="enabled">Enabled</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>

                        <!-- Allowed IPs -->
                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-1">Allowed IPs (CIDR)</label>
                            <p class="mb-2 text-xs text-zinc-500">For UDP sources: enforced at the UDP collector (L4 allow‑list).<br>For API sources: (optional) enforced at HTTP if enabled; for cloud behind proxies, set HTTP_TRUST_XFF=true.</p>
                            <div class="space-y-2">
                                <div id="allowed-ips-container" class="space-y-2">
                                    <!-- IP chips will be added here -->
                                </div>
                                <div class="flex gap-2">
                                    <input id="new-ip-input" type="text" class="input flex-1" placeholder="e.g., 192.168.1.0/24" />
                                    <button id="add-ip-btn" class="btn">Add</button>
                                    <button id="btn-add-my-ip" class="px-3 py-2 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 border border-blue-500/30 rounded-full text-sm font-medium transition-all duration-200 hover:shadow-lg hover:shadow-blue-500/20">Add My IP</button>
                                </div>
                            </div>
                        </div>

                        <!-- Rate Limits -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-zinc-400 mb-1">Max EPS</label>
                                <input id="source-max-eps" type="number" class="input" placeholder="0 = unlimited" min="0" />
                            </div>
                            <div class="flex items-center mt-6">
                                <input id="source-block-on-exceed" type="checkbox" class="mr-2" />
                                <label class="text-sm text-zinc-400">Block on exceed</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Admission -->
                <div>
                    <h4 class="text-sm font-medium text-zinc-400 mb-3">Test Admission</h4>
                    <div class="flex gap-2">
                        <input id="test-ip-input" type="text" class="input flex-1" placeholder="Enter IP to test" />
                        <button id="test-admission-btn" class="btn">Test</button>
                    </div>
                    <div id="test-result" class="mt-2 text-sm hidden"></div>
                </div>

                <!-- Sync Firewall (Admin Only) -->
                <div id="admin-controls" class="hidden">
                    <h4 class="text-sm font-medium text-zinc-400 mb-3">Admin Controls</h4>
                    <button id="sync-firewall-btn" class="px-4 py-2 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 border border-blue-500/30 rounded-full text-sm font-medium transition-all duration-200 hover:shadow-lg hover:shadow-blue-500/20">Sync Firewall</button>
                    <div id="sync-result" class="mt-2 text-sm hidden"></div>
                </div>

                                <!-- Action Buttons -->
                <div class="flex items-center justify-end gap-3 sticky bottom-0 bg-[#0f1115]/90 backdrop-blur border-t border-white/10 px-6 py-4">
                    <button id="source-cancel-btn" class="btn-ghost-gray">Cancel</button>
                    <button id="source-save-btn" class="btn-glow-green">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>
    </div>



    <!-- Defer + cache bust so we always get the latest code and after DOM is parsed -->
    <!-- Drawer markup -->
  <div id="drawer-backdrop" class="fixed inset-0 bg-black/40 hidden"></div>
  <aside id="source-drawer"
         class="fixed top-0 right-0 h-full w-[540px] max-w-[90vw] bg-[#0f1115]/95 backdrop-blur border border-white/10 shadow-2xl
                translate-x-full transition-transform duration-200 z-50 edit-drawer overflow-y-auto">
    <div class="flex items-center justify-between px-6 py-5 border-b border-white/10">
      <h2 id="drawer-title" class="text-lg font-semibold">Source</h2>
      <button id="drawer-close" class="text-white/60 hover:text-white" aria-label="Close">✕</button>
    </div>
    <div id="drawer-content" class="text-white/90 text-sm">
      <!-- content injected by app.js -->
    </div>
  </aside>

  <!-- Backdrop for Create Source drawer -->
  <div id="create-src-backdrop"
       class="fixed inset-0 z-[98] bg-black/50 backdrop-blur-sm hidden"
       onclick="window.closeCreateSourceDrawer()"></div>

  <!-- Right-side Create Source drawer -->
  <aside id="create-src-drawer"
         class="fixed right-0 top-0 h-full w-[540px] max-w-[90vw] z-[99]
                translate-x-full transition-transform duration-200 ease-out
                bg-[#0f1115]/95 backdrop-blur border border-white/10 shadow-2xl hidden overflow-y-auto">
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-5 border-b border-white/10">
      <h2 class="text-lg font-semibold">Create New Source</h2>
      <button class="text-white/60 hover:text-white" onclick="window.closeCreateSourceDrawer()">
        ✕
      </button>
    </div>

    <!-- Body -->
    <form id="form-create-source" class="p-6 space-y-4 pb-28" onsubmit="return window.submitCreateSource(event)">
      <div>
        <label class="text-sm text-white/70">Source ID *</label>
        <input id="create-src-id" required pattern="[a-z0-9_\-]+"
               placeholder="e.g., my-source-01"
               class="mt-1 w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2 outline-none focus:border-blue-500"/>
        <p class="mt-1 text-xs text-white/50">lowercase letters, numbers, hyphens, underscores only</p>
      </div>

      <div>
        <label class="text-sm text-white/70">Display Name</label>
        <input id="create-src-display" placeholder="Human-readable name"
               class="mt-1 w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2 outline-none focus:border-blue-500"/>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-white/70">Tenant</label>
          <input id="create-src-tenant" value="default"
                 class="mt-1 w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2 outline-none focus:border-blue-500"/>
        </div>
        <div>
          <label class="text-sm text-white/70">Type</label>
          <div class="mt-2 flex items-center gap-3">
            <label class="inline-flex items-center gap-2 text-sm text-white/80">
              <input type="radio" name="create-src-type" id="create-src-type-api" value="http" class="accent-blue-500" checked>
              <span>API</span>
            </label>
            <label class="inline-flex items-center gap-2 text-sm text-white/80">
              <input type="radio" name="create-src-type" id="create-src-type-udp" value="udp" class="accent-blue-500">
              <span>UDP</span>
            </label>
          </div>
          <p id="create-src-type-help" class="mt-2 text-xs text-white/50">
            For HTTP senders; optional IP allow‑list can be enforced if enabled on the server.
          </p>
        </div>
      </div>

      <div>
        <label class="text-sm text-white/70">Collector</label>
        <input id="create-src-collector" value="gw-local"
               class="mt-1 w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2 outline-none focus:border-blue-500"/>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-white/70">Status</label>
          <select id="create-src-status"
                  class="mt-1 w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2 outline-none focus:border-blue-500">
            <option value="enabled">Enabled</option>
            <option value="disabled">Disabled</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-white/70">Max EPS (0 = unlimited)</label>
          <input id="create-src-maxeps" type="number" min="0" value="0"
                 class="mt-1 w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2 outline-none focus:border-blue-500"/>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <input id="create-src-block" type="checkbox" class="accent-blue-500" checked>
        <label class="text-sm text-white/80">Block on exceed</label>
      </div>

      <div id="create-src-ips-block">
        <label class="text-sm text-white/70">Allowed IPs (CIDRs, one per line)</label>
        <textarea id="create-src-ips" rows="4" placeholder="127.0.0.1/32&#10;203.0.113.0/24"
                  class="mt-1 w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2 outline-none focus:border-blue-500"></textarea>
        <p class="mt-1 text-xs text-white/50">For UDP sources: enforced at the UDP collector (L4 allow‑list).<br>For API sources: (optional) enforced at HTTP if enabled; for cloud behind proxies, set HTTP_TRUST_XFF=true.</p>
      </div>

      <!-- Footer -->
      <div class="flex items-center justify-end gap-3 sticky bottom-0 bg-[#0f1115]/90 backdrop-blur border-t border-white/10 px-6 py-4">
        <button type="button" onclick="window.closeCreateSourceDrawer()" class="btn-ghost-gray">
          Cancel
        </button>
        <button type="submit" id="btn-create-source" class="btn-glow-blue">
          Create Source
        </button>
      </div>
    </form>
  </aside>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal-backdrop" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm hidden"></div>
  <div id="delete-modal" class="fixed inset-0 z-[101] flex items-center justify-center p-4 hidden">
    <div class="bg-[#0f1115] border border-white/10 rounded-xl shadow-2xl w-full max-w-md">
      <div class="p-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center">
            <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-white">Delete Source</h3>
            <p class="text-sm text-white/60">This action cannot be undone</p>
          </div>
        </div>
        
        <p class="text-white/80 mb-6">
          Are you sure you want to delete <span id="delete-source-name" class="font-medium text-white">this source</span>?
        </p>
        
        <div class="flex gap-3 justify-end">
          <button id="delete-modal-cancel" class="btn-ghost-gray">
            Cancel
          </button>
          <button id="delete-modal-confirm" class="btn-glow-red">
            Delete Source
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load script last, defer + cache bust -->
  <script src="/ui/app.js?v=vefix53" defer></script>
</body>
</html>

